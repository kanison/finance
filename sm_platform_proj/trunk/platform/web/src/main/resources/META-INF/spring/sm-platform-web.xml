<?xml version="1.0" encoding="GBK"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:osgi="http://www.springframework.org/schema/osgi"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
         http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd"
	default-autowire="byName">
	
	<import resource="classpath:META-INF/spring/sm-platform-lang.xml"/>
	<import resource="classpath:META-INF/spring/sm-platform-web-health.xml"/>
	<import resource="classpath:org/codehaus/xfire/spring/xfire.xml"/>
	
	<!--  begin ÅäÖÃHandlerAdapter-->
	<bean class="org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter"/>
	<bean class="org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter"/>
	<bean class="org.springframework.web.servlet.mvc.throwaway.ThrowawayControllerHandlerAdapter"/>
	<bean class="org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter">
		<property name="sessionAttributeStore">
			<bean class="com.tenpay.sm.web.bind.ConversationAttributeStore" />
		</property>
	</bean>
	<bean class="org.springframework.web.servlet.handler.SimpleServletHandlerAdapter" />
	<!-- end -->
	
	<!--  begin ÅäÖÃViewResolver-->
	<bean id="velocityViewResolver"
		class="org.springframework.web.servlet.view.velocity.VelocityViewResolver">
		<property name="prefix" value="/"></property>
		<property name="suffix" value=".vm"></property>
		<property name="order" value="1000"></property>
		<property name="exposeSpringMacroHelpers" value="true" />
		<property name="exposeRequestAttributes" value="true" />
		<property name="exposeSessionAttributes" value="false" />
		<property name="allowRequestOverride" value="true" />
		<property name="allowSessionOverride" value="true" />
		<property name="contentType" value="text/html;charset=UTF-8" />
	</bean>
	<bean id="velocityConfigurer"
		class="org.springframework.web.servlet.view.velocity.VelocityConfigurer">
		<property name="resourceLoaderPath">
			<value>WEB-INF/velocity/</value>
		</property>
		<!-- <property name="configLocation"><value>/WEB-INF/velocity.properties</value></property>  -->
		<property name="velocityProperties">
			<props>
				<prop key="input.encoding">UTF-8</prop>
                <prop key="output.encoding">UTF-8</prop>
                <prop key="contentType">text/html;charset=UTF-8</prop>
				<prop key="parser.pool.size">100</prop>
				
				<prop key="eventhandler.referenceinsertion.class">com.tenpay.sm.web.xss.EscapeHtmlReferenceSkipSomeLeftWords</prop>
				<!-- <prop key="eventhandler.escape.html.match">/msg.*/</prop>  -->
				
				<!--<prop key="velocimacro.library">macros.vm</prop>-->
			</props>
		</property>
	</bean>
	<bean id="escapeHtmlReferenceSkipSomeLeftWords" class="com.tenpay.sm.web.xss.EscapeHtmlReferenceSkipSomeLeftWords"></bean>
	
	<bean id="internalResourceViewResolver"
		class="org.springframework.web.servlet.view.InternalResourceViewResolver">
		<property name="prefix" value="/WEB-INF/jsp/"></property>
		<property name="suffix" value=".jsp"></property>
		<property name="order" value="900"></property>
		<!-- 
		<property name="exposeContextBeansAsAttributes" value="true"></property>
		<property name="exposedContextBeanNames">
			<list>
				<value>pullServiceHandlerInterceptor</value>
			</list>
		</property>
		-->
	</bean>

	<bean id="suffixCompositeViewResolver"
		class="com.tenpay.sm.web.view.SuffixCompositeViewResolver">
		<property name="order" value="800"></property>
		<property name="viewResolvers">
			<map>
				<entry key="jhtm">
					<ref bean="internalResourceViewResolver"/>
				</entry>
				<entry key="JSP">
					<ref bean="internalResourceViewResolver"/>
				</entry>
				<entry key="vhtm">
					<ref bean="velocityViewResolver"/>
				</entry>
				<entry key="htm">
					<ref bean="velocityViewResolver"/>
				</entry>
			</map>
		</property>			
	</bean>
	
	<bean id="toJSONViewResolver" class="com.tenpay.sm.web.view.ToJSONViewResolver">
		<property name="order" value="20"></property>
	</bean>
	<bean id="toXMLViewResolver" class="com.tenpay.sm.web.view.ToXMLViewResolver">
		<property name="order" value="30"></property>
	</bean>
	<bean id="toRESTResolver" class="com.tenpay.sm.web.view.ToRESTViewResolver">
		<property name="order" value="40"></property>
	</bean>
	<bean id="toPullViewResolver" class="com.tenpay.sm.web.view.ToPullViewResolver">
		<property name="order" value="50"></property>
	</bean>
	<bean id="toRAWViewResolver" class="com.tenpay.sm.web.view.ToRAWViewResolver">
		<property name="order" value="60"></property>
	</bean>
	<bean id="toExcelViewResolver" class="com.tenpay.sm.web.view.ToExcelViewResolver">
		<property name="order" value="70"></property>
	</bean>
	
	<bean id="toXMLView" class="com.tenpay.sm.web.view.ToXMLView"/>
	<bean id="toJSONView" class="com.tenpay.sm.web.view.ToJSONView"/>
	<bean id="toRESTView" class="com.tenpay.sm.web.view.ToRESTView"/>
	<bean id="toPullView" class="com.tenpay.sm.web.view.ToPullView"/>
	<bean id="toRAWView" class="com.tenpay.sm.web.view.ToRAWView"/>
	<bean id="toExcelView" class="com.tenpay.sm.web.view.ToExcelView"/>
	
	<!--<bean id="viewNameTranslator"
		class="org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator">
		<property name="stripExtension" value="false"/>
	</bean>-->
	<bean id="viewNameTranslator"
		class="com.tenpay.sm.web.locale.LocaleRequestToViewNameTranslator">
		<property name="stripExtension" value="false"/>
	</bean>
	<!-- end -->
	
	<bean id="multiViewExceptionResolver" class="com.tenpay.sm.web.bind.exception.MultiViewExceptionResolver"></bean>

	<bean id="pullServiceHandlerInterceptor" class="com.tenpay.sm.web.pull.PullServiceHandlerInterceptor">
		<property name="globalTool">
			<map>
				<entry key="module">
					<bean class="com.tenpay.sm.web.tag.ModuleExecutor"/>
				</entry>
				<entry key="plugin">
					<bean class="com.tenpay.sm.web.tag.SmPluginExecutor"/>
				</entry>
				<entry key="appConfig">
					<ref bean="appConfig"/>
				</entry>
				<entry key="defaultMashupContent">
					<ref bean="defaultMashupContent"/>
				</entry>
				<entry key="sessionScope">
					<bean class="com.tenpay.sm.web.session.SessionScopeLazyImpl"></bean>
				</entry>				
			</map>
		</property>
	</bean>
	
	<!--  begin ÅäÖÃHandlerMapping-->
	<bean id="simpleUrlHandlerMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"> 
		<property name="order" value="0"></property> 
        <property name="urlMap">  
            <map>  
                <entry key="/webContentFacade">  
                    <ref bean="webContentServiceExporter" />  
                </entry>
                <entry key="/mashupServerFacade">  
                    <ref bean="mashupServerServiceExporter" />  
                </entry>   
            </map>  
        </property>  
    </bean>  
	<bean id="abstractHandlerMapping" abstract="true">
		<property name="interceptors">
			<list>
				<bean class="com.tenpay.sm.web.context.WebModuleContextHandlerInterceptor"/>
				<!--<bean class="com.tenpay.sm.web.resubmit.FormTokenHandlerInterceptor"/>-->
				<bean class="com.tenpay.sm.web.conversation.ConversationHandlerInteceptor"/>
				<ref bean="pullServiceHandlerInterceptor"/>
				<bean class="com.tenpay.sm.web.view.CurrentViewUtilFirstHandlerInterceptor"/>
				<bean class="com.tenpay.sm.web.model.AdditionalHandlerInterceptor"/>
				<bean class="com.tenpay.sm.web.view.Model2CurrentHandlerInterceptor"/>
			</list>
		</property>
	</bean>
	<bean id="multiExtBeanNameUrlHandlerMapping" parent="abstractHandlerMapping"
		class="com.tenpay.sm.web.handler.MultiExtBeanNameUrlHandlerMapping">		
		<property name="order" value="4"></property>
		<property name="suffixes">
			<list>
				<value>.htm</value>
				<value>.jhtm</value>
				<value>.JSP</value>
				<value>.vhtm</value>
				<value>.json</value>
				<value>.xml</value>
				<value>.rest</value>				
				<value>.pull</value>
				<value>.api</value>
				<value>.xmlori</value>
				<value>.raw</value>	
				<value>.cgi</value>
				<value>.xls</value>
				<value>.relay</value>			
			</list>
		</property>
	</bean>	
	<bean id="defaultHandlerMapping" parent="abstractHandlerMapping"
		class="com.tenpay.sm.web.handler.DefaultHandlerMapping">
		<property name="order" value="9999"></property>
	</bean>
	<bean id="defaultController"
		class="com.tenpay.sm.web.controller.DefaultController" />
	<!-- end -->
	
	<!--  begin ÑéÖ¤À¹½Ø-->
	<bean class="org.springframework.aop.support.DefaultPointcutAdvisor">
		<property name="pointcut">
			<bean class="com.tenpay.sm.web.validate.ValidatePointcut"></bean>
		</property>
		<property name="advice">
			<ref bean="validateMethodInterceptor"/>
		</property>
	</bean>
	<bean id="validateMethodInterceptor" class="com.tenpay.sm.web.validate.ValidateMethodInterceptor">
		<property name="validators">
			<map>
				<entry key="beanValidator">
					<ref bean="beanValidator"/>
				</entry>
			</map>
		</property>
	</bean>
	
    <bean id="beanValidator" class="org.springmodules.validation.commons.DefaultBeanValidator"/>
	<!-- end -->
	
	<!--  begin Æ¥ÅäÀ¹½Ø-->
	<bean class="org.springframework.aop.support.DefaultPointcutAdvisor">
		<property name="pointcut">
			<bean class="com.tenpay.sm.web.module.ModuleMatchBeanPointCut"></bean>
		</property>
		<property name="advice">
			<ref bean="moduleMatchBeanMethodInterceptor"/>
		</property>
	</bean>
	<bean id="moduleMatchBeanMethodInterceptor" class="com.tenpay.sm.web.module.ModuleMatchBeanMethodInterceptor">
	</bean>
	<!-- end -->
	
	<!--  begin mashServer api Exporter and mashServer and mashupAPI Client-->
	<bean id="webContentFacade___ServerImpl" class="com.tenpay.sm.web.export.WebContentFacadeServerImpl"/>
	<bean id="webContentServiceExporter" class="org.codehaus.xfire.spring.remoting.XFireExporter">  
        <property name="serviceFactory">  
            <ref bean="xfire.serviceFactory" />  
        </property>  
        <property name="xfire">  
            <ref bean="xfire" />  
        </property>  
        <property name="serviceBean">  
            <ref bean="webContentFacade___ServerImpl" />  
        </property>  
        <property name="serviceClass">  
            <value>com.tenpay.sm.client.facade.WebContentFacade</value>  
        </property>  
    </bean>  
    
    <bean id="defaultMashupContent" class="com.tenpay.sm.web.mashup.DefaultMashupContent"/>
    <bean id="mashupServerFacadeImpl" class="com.tenpay.sm.web.mashupserver.MashupServerFacadeImpl">
    	<property name="cache">
    		<bean class="com.tenpay.sm.cache.local.LocalLRUCacheImpl"/>
    	</property>
    </bean>
	<bean id="mashupServerServiceExporter" class="org.codehaus.xfire.spring.remoting.XFireExporter">  
        <property name="serviceFactory">  
            <ref bean="xfire.serviceFactory" />  
        </property>  
        <property name="xfire">  
            <ref bean="xfire" />  
        </property>  
        <property name="serviceBean">  
            <ref bean="mashupServerFacadeImpl" />  
        </property>  
        <property name="serviceClass">  
            <value>com.tenpay.sm.client.facade.MashupServerFacade</value>  
        </property>  
    </bean> 
    
    <bean id="webContentFacadeClientImplInServer" class="com.tenpay.sm.web.mashupapi.WebContentFacadeClientImplInServer"/>
    <bean id="tagResourceEngine" class="com.tenpay.sm.web.mashupserver.TagResourceEngineImpl"/>
    <bean id="ignoreTag" class="com.tenpay.sm.web.mashupserver.IgnoreTag"/>
    <!-- end -->
    
    <!--  httpSessionCache 
    <bean id="httpSessionCache" class="com.tenpay.sm.cache.center.JavaMemCachedWrapper">
		<property name="memCachedConfig">
			<bean class="com.tenpay.sm.cache.center.MemCachedConfig">
				<property name="servers">
					<list>
						<value>localhost:11211</value>
						<value>localhost:11211</value>
						<value>localhost:11211</value>
						<value>localhost:11211</value>
					</list>
				</property>
			</bean>
		</property>
	</bean>
 		end -->
	
	<!-- begin rest service gate -->
	<bean name="/rest/servicegate" class="com.tenpay.sm.web.rest.ServiceGate"></bean>
	<!-- end -->
</beans>
